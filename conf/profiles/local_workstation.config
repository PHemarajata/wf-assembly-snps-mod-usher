/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Local workstation profile (12 cores, 64GB RAM)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

params {
    config_profile_name        = 'Local workstation'
    config_profile_description = 'Local workstation profile for 12 cores and 64GB RAM'
    
    // Maximum resource limits
    max_cpus   = 12
    max_memory = '64.GB'
    max_time   = '240.h'
}

process {
    // Standard defaults optimized for local workstation
    cpus              = { check_max( 1    * task.attempt, 'cpus'     ) }
    memory            = { check_max( 4.GB * task.attempt, 'memory'   ) }
    time              = { check_max( 4.h  * task.attempt, 'time'     ) }

    errorStrategy     = { task.exitStatus in [71,104,134,137,139,140,143,255] ? 'retry' : 'finish' }
    maxRetries        = 2
    maxErrors         = '-1'

    // Process-specific resource requirements optimized for clustering workflow
    withLabel:process_single {
        cpus          = { check_max( 1                  , 'cpus'     ) }
        memory        = { check_max( 2.GB * task.attempt, 'memory'   ) }
        time          = { check_max( 2.h  * task.attempt, 'time'     ) }
    }
    withLabel:process_low {
        cpus          = { check_max( 2     * task.attempt, 'cpus'    ) }
        memory        = { check_max( 4.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 4.h   * task.attempt, 'time'    ) }
    }
    withLabel:process_medium {
        cpus          = { check_max( 4     * task.attempt, 'cpus'    ) }
        memory        = { check_max( 8.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 8.h   * task.attempt, 'time'    ) }
        maxForks      = 2  // Limit concurrent medium processes
    }
    withLabel:process_high {
        cpus          = { check_max( 6    * task.attempt, 'cpus'    ) }
        memory        = { check_max( 16.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 24.h   * task.attempt, 'time'   ) }
        maxForks      = 1  // Only one high-resource process at a time
    }
    withLabel:process_long {
        time          = { check_max( 96.h  * task.attempt, 'time'    ) }
    }
    withLabel:process_high_memory {
        memory        = { check_max( 32.GB * task.attempt, 'memory' ) }
        maxForks      = 1  // Limit memory-intensive processes
    }

    // Specific optimizations for clustering workflow
    withName:MASH_SKETCH {
        cpus   = 1
        memory = '1.GB'
        time   = '1.h'
    }
    withName:MASH_DIST {
        cpus   = 2
        memory = '4.GB'
        time   = '2.h'
    }
    withName:CLUSTER_GENOMES {
        cpus   = 1
        memory = '2.GB'
        time   = '1.h'
    }
    withName:SKA_ALIGN {
        cpus   = 2
        memory = '4.GB'
        time   = '2.h'
    }
    withName:IQTREE_FAST {
        cpus   = 4
        memory = '8.GB'
        time   = '4.h'
    }
    withName:GUBBINS_CLUSTER_DIAGNOSTIC {
        cpus     = 4
        memory   = '12.GB'
        time     = '12.h'
        maxForks = 1  // Only one Gubbins process at a time
    }
    withName:USHER_BUILD {
        cpus   = 4
        memory = '8.GB'
        time   = '4.h'
    }
    withName:USHER_PLACE {
        cpus   = 2
        memory = '4.GB'
        time   = '2.h'
    }
}

executor {
    name = 'local'
    cpus = 12
    memory = '64.GB'
}
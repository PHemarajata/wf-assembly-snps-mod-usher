/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    DGX Station A100 Updated profile (128 cores, 512GB RAM, A100 GPUs)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
*/

params {
    config_profile_name        = 'DGX Station A100 Updated'
    config_profile_description = 'Updated DGX Station A100 profile for 128 cores, 512GB RAM with overhead considerations'
    
    // Maximum resource limits (leaving overhead: 120 cores, 480GB RAM)
    max_cpus   = 120
    max_memory = '480.GB'
    max_time   = '240.h'
}

process {
    // Standard defaults optimized for DGX Station A100
    cpus              = { check_max( 4    * task.attempt, 'cpus'     ) }
    memory            = { check_max( 8.GB * task.attempt, 'memory'   ) }
    time              = { check_max( 4.h  * task.attempt, 'time'     ) }

    errorStrategy     = { task.exitStatus in [71,104,134,137,139,140,143,255] ? 'retry' : 'finish' }
    maxRetries        = 2
    maxErrors         = '-1'

    // Process-specific resource requirements optimized for high-performance system
    withLabel:process_single {
        cpus          = { check_max( 1                  , 'cpus'     ) }
        memory        = { check_max( 4.GB * task.attempt, 'memory'   ) }
        time          = { check_max( 2.h  * task.attempt, 'time'     ) }
    }
    withLabel:process_low {
        cpus          = { check_max( 4     * task.attempt, 'cpus'    ) }
        memory        = { check_max( 8.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 4.h   * task.attempt, 'time'    ) }
        maxForks      = 20  // Allow many concurrent low processes
    }
    withLabel:process_medium {
        cpus          = { check_max( 8     * task.attempt, 'cpus'    ) }
        memory        = { check_max( 16.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 8.h   * task.attempt, 'time'    ) }
        maxForks      = 10  // Allow multiple medium processes
    }
    withLabel:process_high {
        cpus          = { check_max( 16    * task.attempt, 'cpus'    ) }
        memory        = { check_max( 64.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 24.h   * task.attempt, 'time'   ) }
        maxForks      = 6   // Allow multiple high-resource processes
    }
    withLabel:process_long {
        time          = { check_max( 96.h  * task.attempt, 'time'    ) }
    }
    withLabel:process_high_memory {
        memory        = { check_max( 120.GB * task.attempt, 'memory' ) }
        maxForks      = 3   // Limit very memory-intensive processes
    }

    // Specific optimizations for clustering workflow on DGX A100
    withName:MASH_SKETCH {
        cpus   = 4
        memory = '8.GB'
        time   = '30.m'
    }
    withName:MASH_DIST {
        cpus   = 12
        memory = '24.GB'
        time   = '1.h'
    }
    withName:CLUSTER_GENOMES {
        cpus   = 6
        memory = '12.GB'
        time   = '30.m'
    }
    withName:SKA_BUILD {
        cpus   = 12
        memory = '24.GB'
        time   = '1.h'
    }
    withName:SKA_ALIGN {
        cpus   = 12
        memory = '24.GB'
        time   = '1.h'
    }
    withName:IQTREE_FAST {
        cpus   = 20
        memory = '40.GB'
        time   = '2.h'
    }
    withName:GUBBINS_CLUSTER {
        cpus     = 20
        memory   = '80.GB'
        time     = '6.h'
        maxForks = 4  // Allow multiple Gubbins processes
    }
    withName:USHER_BUILD {
        cpus   = 20
        memory = '40.GB'
        time   = '2.h'
    }
    withName:USHER_PLACE {
        cpus   = 12
        memory = '24.GB'
        time   = '1.h'
    }
    
    // Large-scale phylogenetic processes
    withName:BUILD_PHYLOGENETIC_TREE_PARSNP {
        cpus   = 24
        memory = '96.GB'
        time   = '12.h'
    }
    withName:CORE_GENOME_ALIGNMENT_PARSNP {
        cpus   = 16
        memory = '64.GB'
        time   = '8.h'
    }
    withName:BUILD_INTEGRATED_TREE {
        cpus   = 24
        memory = '96.GB'
        time   = '12.h'
    }
    
    // GPU-accelerated processes (if available in future)
    withName:GPU_ACCELERATED {
        accelerator = [request: 1, type: 'nvidia-a100']
        cpus        = 8
        memory      = '32.GB'
        time        = '2.h'
    }
}

executor {
    name = 'local'
    cpus = 120
    memory = '480.GB'
}